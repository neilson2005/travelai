<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½æ—…éŠè¦åŠƒå™¨</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f7f9fc;
        }
        @keyframes scale-up {
            0% { transform: scale(0.96); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-scale-up {
            animation: scale-up 0.18s ease-out;
        }
    </style>
</head>
<body class="min-h-screen">

<div class="flex flex-col lg:flex-row font-sans text-gray-800">
    <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
    <div id="control-panel" class="w-full lg:w-1/3 bg-white p-6 lg:p-8 border-r border-gray-200 shadow-xl z-20 flex flex-col h-auto lg:h-screen lg:sticky lg:top-0">
        <div class="mb-8">
            <h1 class="text-3xl font-bold flex items-center gap-3 text-indigo-600 mb-2 tracking-tight">
                <div class="p-2 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-200">
                    <i data-lucide="sparkles" class="text-white fill-current w-6 h-6"></i>
                </div>
                Vibe Travel
            </h1>
            <p class="text-gray-500 font-medium ml-1">AI é©…å‹•çš„æ™ºèƒ½æ—…éŠè¦åŠƒ</p>
        </div>

        <!-- API è­¦å‘Š -->
        <div id="api-warning" class="hidden mb-6 p-4 bg-amber-50 text-amber-800 rounded-xl border border-amber-200 text-sm gap-3 shadow-sm flex">
            <i data-lucide="info" class="flex-shrink-0 w-5 h-5"></i>
            <div>
                <p class="font-bold mb-1">API é€£ç·šå•é¡Œ</p>
                <p class="opacity-90 leading-relaxed">
                    ç›®å‰ç„¡æ³•é€£ç·š AI æœå‹™ã€‚ç³»çµ±å°‡é¡¯ç¤ºã€Œç¯„ä¾‹è¡Œç¨‹ã€ã€‚
                </p>
            </div>
        </div>

        <!-- æŠŠæŒ‰éˆ•ä¸€èµ·åŒ…åœ¨ form è£¡ -->
        <form id="plan-form" class="space-y-6 flex-grow overflow-y-auto pr-1 custom-scrollbar">
            <!-- ç›®çš„åœ° -->
            <div class="space-y-1">
                <label class="block text-sm font-bold text-gray-700 ml-1" for="destination">ç›®çš„åœ°</label>
                <div class="relative group">
                    <i data-lucide="map-pin" class="absolute left-3 top-3.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors w-5 h-5"></i>
                    <input type="text" id="destination" value="åŒ—æµ·é“" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-medium" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€å·´é»..." required>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- å¤©æ•¸ -->
                <div class="space-y-1">
                    <label class="block text-sm font-bold text-gray-700 ml-1" for="days">å¤©æ•¸</label>
                    <div class="relative group">
                        <i data-lucide="calendar" class="absolute left-3 top-3.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors w-5 h-5"></i>
                        <input type="number" id="days" value="5" min="1" max="14" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-medium" required>
                    </div>
                </div>
                
                <!-- é ç®—èˆ‡å¹£åˆ¥ -->
                <div class="space-y-1">
                    <label class="block text-sm font-bold text-gray-700 ml-1" for="budget">é ç®— & å¹£åˆ¥</label>
                    <div class="flex gap-2">
                        <div class="relative group flex-grow">
                            <i data-lucide="dollar-sign" class="absolute left-3 top-3.5 text-gray-400 group-focus-within:text-indigo-500 transition-colors w-5 h-5"></i>
                            <input type="number" id="budget" value="5000" min="0" class="w-full pl-10 p-3 bg-gray-50 border border-gray-200 rounded-l-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-medium" required>
                        </div>
                        <select id="currency" class="w-24 p-3 bg-gray-50 border border-l-0 border-gray-200 rounded-r-xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold text-gray-600 cursor-pointer hover:bg-gray-100 transition-colors">
                            <option value="MYR">MYR</option>
                            <option value="TWD">TWD</option>
                            <option value="USD">USD</option>
                            <option value="JPY">JPY</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- æ—…éŠé¢¨æ ¼ -->
            <div class="space-y-1">
                <label class="block text-sm font-bold text-gray-700 ml-1" for="style">æ—…éŠé¢¨æ ¼</label>
                <div class="relative">
                    <input type="text" id="style" value="è³é›ªç¾é£Ÿ" placeholder="ä¾‹å¦‚ï¼šè¦ªå­ã€æƒ…ä¾¶æ”¾é¬†ã€æ¥µé™é‹å‹•..." class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all font-medium placeholder:text-gray-400" required>
                </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div id="error-message" class="hidden p-4 bg-red-50 text-red-600 rounded-xl flex items-center gap-2 text-sm border border-red-100">
                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                <span id="error-text"></span>
            </div>

            <!-- æŒ‰éˆ•åœ¨ form è£¡ï¼Œtype=submit -->
            <div class="mt-8 pt-6 border-t border-gray-100">
                <button id="generate-button" type="submit" class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg hover:shadow-indigo-200 transition-all flex justify-center items-center gap-2 transform active:scale-[0.98] bg-gradient-to-r from-indigo-600 to-purple-600 hover:brightness-110">
                    <i data-lucide="sparkles" class="w-5 h-5 animate-pulse"></i>
                    <span id="button-text">é–‹å§‹ AI è¦åŠƒ</span>
                </button>
            </div>
        </form>
    </div>

    <!-- å³å´å…§å®¹ -->
    <div id="main-content" class="w-full lg:w-2/3 p-4 md:p-8 lg:p-12 overflow-y-auto bg-gray-50/50 min-h-screen">
        <div id="initial-state" class="h-full flex flex-col items-center justify-center text-gray-400 opacity-60 min-h-[50vh]">
            <div class="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-6">
               <i data-lucide="map-pin" class="w-12 h-12 text-gray-400"></i>
            </div>
            <p class="text-xl font-medium">è¼¸å…¥æ‚¨çš„å¤¢æƒ³ï¼Œé»æ“ŠæŒ‰éˆ•</p>
            <p class="text-sm mt-2">AI å°‡ç‚ºæ‚¨ç”Ÿæˆå°ˆå±¬è¡Œç¨‹</p>
        </div>

        <div id="loading-state" class="hidden h-full flex flex-col items-center justify-center min-h-[50vh] space-y-6">
            <div class="w-full max-w-2xl bg-white p-6 rounded-3xl shadow-sm space-y-4">
                <div class="w-3/4 h-8 bg-gray-200 rounded animate-pulse"></div>
                <div class="w-full h-4 bg-gray-100 rounded animate-pulse"></div>
                <div class="w-5/6 h-4 bg-gray-100 rounded animate-pulse"></div>
            </div>
            <div class="w-full max-w-2xl grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="h-48 bg-gray-200 rounded-3xl animate-pulse"></div>
                <div class="h-48 bg-gray-200 rounded-3xl animate-pulse"></div>
            </div>
        </div>

        <div id="plan-output" class="hidden space-y-8 pb-6">
            <!-- JS render -->
        </div>

        <!-- æ–°å¢ï¼šè¡Œç¨‹èª¿æ•´å°è©±æ¬„ -->
        <div id="chat-panel" class="hidden mt-4">
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-4 md:p-6 flex flex-col h-72">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="messages-square" class="w-5 h-5 text-indigo-500"></i>
                        è¡Œç¨‹èª¿æ•´å°è©±
                    </h3>
                    <span class="text-xs text-gray-400">åœ¨é€™è£¡è¨˜éŒ„è¦èª¿æ•´çš„é‡é»</span>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto custom-scrollbar space-y-3 text-sm text-gray-700 bg-gray-50 rounded-2xl p-3">
                    <!-- å°è©±è¨Šæ¯ -->
                </div>
                <form id="chat-form" class="mt-3 flex gap-2">
                    <input id="chat-input" type="text" class="flex-1 rounded-2xl border border-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-gray-50" placeholder="ä¾‹å¦‚ï¼šç¬¬ 2 å¤©ä¸‹åˆæƒ³æ”¹æˆé€› outlet..." />
                    <button type="submit" class="px-4 py-2 text-sm font-bold rounded-2xl bg-indigo-600 text-white hover:bg-indigo-700 flex items-center gap-1">
                        <i data-lucide="send" class="w-4 h-4"></i>
                        é€å‡º
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal-backdrop" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div id="modal-content-container" class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] overflow-hidden flex flex-col animate-scale-up">
        <!-- JS æ³¨å…¥ -->
    </div>
</div>

<script>
    // åˆå§‹åŒ– Lucide
    document.addEventListener('DOMContentLoaded', () => {
        if (window.lucide) {
            window.lucide.createIcons();
        }
    });

    // ========= è¨­å®š =========
    const apiKey = "AIzaSyDpFVyY4VHWwVJ8NgzWp0mtcHogLEjh9_s"; // ç•™ç©ºä»£è¡¨ç”¨ MOCK DEMO
    const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

    const isApiReady = () => typeof apiKey === "string" && apiKey.trim() !== "";

    // ========= æ¨¡æ“¬è³‡æ–™ =========
    const MOCK_DATA = {
        summary: "ã€æ¼”ç¤ºè³‡æ–™ã€‘é€™æ˜¯å°åŒ—çš„ç¯„ä¾‹è¡Œç¨‹ã€‚ç”±æ–¼ç›®å‰ API é€£ç·šä¸­æ–·ï¼Œç³»çµ±é¡¯ç¤ºæ­¤ç¯„ä¾‹ä¾›æ‚¨åƒè€ƒä»‹é¢æ•ˆæœã€‚",
        total_budget: 3500,
        breakdown: [
            { name: 'ä½å®¿', value: 1500 },
            { name: 'é¤é£²', value: 850 },
            { name: 'è³¼ç‰©', value: 800 },
            { name: 'äº¤é€š', value: 350 },
        ],
        itinerary: [
            { day: 1, date: "Day 1", activities: [
                { time: "10:00 - 11:30", type: "äº¤é€š", title: "æŠµé”å°åŒ— (ç¯„ä¾‹)", description: "æ­¤ç‚ºæ¨¡æ“¬è³‡æ–™ï¼ŒçœŸå¯¦ç”Ÿæˆéœ€é€£æ¥ API", cost: 300, location: "æ¡ƒåœ’æ©Ÿå ´" },
                { time: "11:45 - 12:45", type: "ä½å®¿", title: "è¾¦ç†å…¥ä½", description: "æ”¾ä¸‹è¡Œæï¼Œæº–å‚™é–‹å§‹æ—…ç¨‹", cost: 1500, location: "è¥¿é–€ç”ºé£¯åº—" },
                { time: "13:00 - 14:30", type: "ç¾é£Ÿ", title: "æ°¸åº·è¡—ç‰›è‚‰éºµ", description: "äº«ç”¨åœ¨åœ°ç‰¹è‰²ç¾é£Ÿ", cost: 150, location: "æ°¸åº·è¡—" },
                { time: "15:00 - 17:00", type: "æ™¯é»", title: "å°åŒ— 101 è§€å…‰", description: "åƒè§€åŸå¸‚æœ€è‘—åçš„åœ°æ¨™", cost: 120, location: "ä¿¡ç¾©å€" },
            ]},
            { day: 2, date: "Day 2", activities: [
                { time: "09:00 - 10:00", type: "ç¾é£Ÿ", title: "é£¯åº—æ—©é¤", description: "äº«ç”¨è±ç››æ—©é¤", cost: 0, location: "é£¯åº—" },
                { time: "10:30 - 13:00", type: "è³¼ç‰©", title: "ä¿¡ç¾©å€è³¼ç‰©ä¸­å¿ƒ", description: "è³¼è²·ä¼´æ‰‹ç¦®èˆ‡ç´€å¿µå“", cost: 500, location: "è³¼ç‰©å€" },
                { time: "13:30 - 15:00", type: "ç¾é£Ÿ", title: "è¯å±±æ–‡å‰µä¸‹åˆèŒ¶", description: "æ”¾é¬†èº«å¿ƒçš„åˆå¾Œ", cost: 120, location: "è¯å±±" },
                { time: "16:00 - 18:00", type: "æ™¯é»", title: "æ¾å±±æ–‡å‰µåœ’å€", description: "é«”é©—ç•¶åœ°æ–‡åŒ–èˆ‡è—è¡“", cost: 20, location: "æ–‡å‰µå€" },
            ]},
        ]
    };

    const MOCK_PACKING_LIST = {
        categories: [
            { name: "é‡è¦æ–‡ä»¶", items: ["è­·ç…§/èº«åˆ†è­‰", "æ©Ÿç¥¨/è»Šç¥¨è­‰æ˜", "ç¾é‡‘ (TWD/å¤–å¹£)"] },
            { name: "è¡£ç‰©", items: ["æ›æ´—è¡£ç‰©", "å¥½èµ°çš„é‹", "å¤–å¥—", "ç¡è¡£"] },
            { name: "é›»å­ç”¢å“", items: ["æ‰‹æ©Ÿ", "å……é›»å™¨/è¡Œå‹•é›»æº"] }
        ]
    };
    const MOCK_TIPS = "ğŸ’¡ æ¼”ç¤ºå»ºè­°ï¼šé€™æ˜¯ä¸€å€‹ç¯„ä¾‹æç¤ºã€‚çœŸæ­£çš„ AI å»ºè­°æœƒæä¾›æœ€ä½³æ‹ç…§é»ã€å¿…é»èœè‰²æˆ–é¿é–‹äººæ½®æ™‚é–“ï¼";

    // ========= DOM =========
    const destinationInput = document.getElementById('destination');
    const daysInput = document.getElementById('days');
    const budgetInput = document.getElementById('budget');
    const currencySelect = document.getElementById('currency');
    const styleInput = document.getElementById('style');
    const generateButton = document.getElementById('generate-button');
    const buttonText = document.getElementById('button-text');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const initialState = document.getElementById('initial-state');
    const loadingState = document.getElementById('loading-state');
    const planOutput = document.getElementById('plan-output');
    const apiWarning = document.getElementById('api-warning');

    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalContentContainer = document.getElementById('modal-content-container');

    const chatPanel = document.getElementById('chat-panel');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // ========= ç‹€æ…‹ =========
    let currentPlan = null;
    let isGenerating = false;
    let currentFormData = {};

    // ========= è¼”åŠ© =========
    const escapeHtml = (str = "") => {
        return String(str).replace(/[&<>"']/g, c => {
            switch (c) {
                case '&': return '&amp;';
                case '<': return '&lt;';
                case '>': return '&gt;';
                case '"': return '&quot;';
                case "'": return '&#39;';
                default: return c;
            }
        });
    };

    const iconHtml = (iconName, classes = 'w-4 h-4') => {
        return `<i data-lucide="${iconName}" class="${classes}"></i>`;
    };

    const appendChatMessage = (sender, text) => {
        if (!chatMessages) return;
        const wrapper = document.createElement('div');
        const isUser = sender === 'user';
        wrapper.className = 'flex ' + (isUser ? 'justify-end' : 'justify-start');
        wrapper.innerHTML = `
            <div class="max-w-[80%] rounded-2xl px-3 py-2 text-xs md:text-sm ${isUser ? 'bg-indigo-600 text-white' : 'bg-white border border-gray-200 text-gray-800'}">
                ${escapeHtml(text)}
            </div>
        `;
        chatMessages.appendChild(wrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    const getTagHtml = (type) => {
        const map = {
            "äº¤é€š": { icon: "train", color: "blue" },
            "ç¾é£Ÿ": { icon: "utensils", color: "orange" },
            "æ™¯é»": { icon: "camera", color: "emerald" },
            "ä½å®¿": { icon: "hotel", color: "purple" },
            "è³¼ç‰©": { icon: "shopping-bag", color: "pink" },
            "å…¶ä»–": { icon: "sparkles", color: "gray" },
        };
        const { icon, color } = map[type] || map["å…¶ä»–"];
        return `
            <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-semibold border bg-${color}-100 text-${color}-700 border-${color}-200">
                ${iconHtml(icon, 'w-3 h-3 mr-1')} ${type}
            </span>
        `;
    };

    const renderBreakdown = (breakdown) => {
        if (!Array.isArray(breakdown) || breakdown.length === 0) return '';
        const listItems = breakdown.map(item => {
            const val = Number(item.value) || 0;
            return `
                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                    <span class="text-gray-600 font-medium">${escapeHtml(item.name)}</span>
                    <span class="text-indigo-600 font-bold">${currentFormData.currency} ${val.toLocaleString()}</span>
                </div>
            `;
        }).join('');
        return `
            <div class="w-full md:w-2/3 bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                <h4 class="text-lg font-bold text-gray-700 mb-3">é ç®—åˆ†ä½ˆ</h4>
                ${listItems}
            </div>
        `;
    };

    const renderItinerary = (itinerary) => {
        if (!Array.isArray(itinerary) || itinerary.length === 0) return '';

        return itinerary.map(dayPlan => {
            const activities = Array.isArray(dayPlan.activities) ? dayPlan.activities : [];
            const activitiesHtml = activities.map(activity => {
                const costValue = Number(activity.cost) || 0;
                const costHtml = costValue > 0
                    ? `<span class="flex items-center gap-1.5 font-medium text-xs text-gray-600 px-2 py-1 bg-yellow-50 rounded-md">${iconHtml('dollar-sign', 'w-3 h-3 text-yellow-600')} ${currentFormData.currency} ${costValue.toLocaleString()}</span>`
                    : `<span class="flex items-center gap-1.5 font-medium text-xs text-emerald-600 px-2 py-1 bg-emerald-50 rounded-md">${iconHtml('sparkles', 'w-3 h-3')} å…è²»</span>`;

                const safeTitle = escapeHtml(activity.title || '');
                const safeLocation = escapeHtml(activity.location || '');

                return `
                    <div class="relative pl-10">
                        <div class="absolute -left-[9px] top-1.5 w-4 h-4 rounded-full bg-indigo-500 border-4 border-white shadow-sm z-10"></div>
                        <div class="pb-10">
                            <div class="flex justify-between items-start mb-2 gap-2">
                                <div class="flex flex-wrap items-center gap-2">
                                    <span class="text-sm font-mono text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded">${escapeHtml(activity.time || '')}</span>
                                    ${getTagHtml(activity.type || 'å…¶ä»–')}
                                </div>
                                <label class="inline-flex items-center gap-1 text-xs text-gray-400 cursor-pointer">
                                    <input type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 js-activity-checkbox" data-day="${dayPlan.day}">
                                    <span>èª¿æ•´</span>
                                </label>
                            </div>
                            <h4 class="text-lg font-bold text-gray-800 mb-2">${safeTitle}</h4>
                            <p class="text-gray-600 text-sm mb-3 leading-relaxed bg-gray-50 p-3 rounded-lg border border-gray-100 inline-block w-full">${escapeHtml(activity.description || '')}</p>
                            <div class="flex flex-wrap items-center gap-4 mt-1">
                                <span class="flex items-center gap-1.5 px-2 py-1 bg-gray-100 rounded-md text-xs text-gray-500">
                                    ${iconHtml('map-pin', 'w-3 h-3 text-gray-400')} ${safeLocation}
                                </span>
                                ${costHtml}
                                <button type="button" class="text-xs font-bold text-amber-600 bg-amber-50 hover:bg-amber-100 border border-amber-200 px-3 py-1.5 rounded-full flex items-center gap-1.5 transition-all shadow-sm js-tips-btn" data-title="${safeTitle}" data-location="${safeLocation}">
                                    ${iconHtml('lightbulb', 'w-3 h-3')} é”äººæ”»ç•¥
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-gray-50 to-white p-6 border-b border-gray-100">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div class="flex items-center gap-2">
                                <span class="bg-indigo-600 text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm">${dayPlan.day}</span>
                                <h3 class="text-xl font-bold text-gray-800">ç¬¬ ${dayPlan.day} å¤©</h3>
                            </div>
                            <div class="flex items-center gap-4">
                                <div class="text-sm font-medium text-gray-400 bg-white px-3 py-1 rounded-full border border-gray-100 shadow-sm">${escapeHtml(dayPlan.date || `Day ${dayPlan.day}`)}</div>
                                <label class="inline-flex items-center gap-1 text-xs text-gray-500 cursor-pointer">
                                    <input type="checkbox" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 js-day-select-all" data-day="${dayPlan.day}">
                                    <span>é¸å–ç•¶æ—¥å…¨éƒ¨è¡Œç¨‹</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 md:p-8">
                        <div class="relative border-l-2 border-indigo-100 ml-3 md:ml-4 space-y-10 pb-2">
                            ${activitiesHtml}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    };

    const setupSelectionHandlers = () => {
        const dayCheckboxes = planOutput.querySelectorAll('.js-day-select-all');
        const activityCheckboxes = planOutput.querySelectorAll('.js-activity-checkbox');

        const updateDayCheckboxState = (day) => {
            const dayCb = planOutput.querySelector(`.js-day-select-all[data-day="${day}"]`);
            if (!dayCb) return;
            const activities = planOutput.querySelectorAll(`.js-activity-checkbox[data-day="${day}"]`);
            if (!activities.length) return;
            const allChecked = Array.from(activities).every(cb => cb.checked);
            const someChecked = Array.from(activities).some(cb => cb.checked);
            dayCb.checked = allChecked;
            dayCb.indeterminate = !allChecked && someChecked;
        };

        dayCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const day = cb.dataset.day;
                const activities = planOutput.querySelectorAll(`.js-activity-checkbox[data-day="${day}"]`);
                activities.forEach(actCb => {
                    actCb.checked = cb.checked;
                });
                cb.indeterminate = false;
            });
        });

        activityCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const day = cb.dataset.day;
                updateDayCheckboxState(day);
            });
        });
    };

    const renderPlan = (plan) => {
        const totalBudget = Number(plan.total_budget) || 0;
        planOutput.innerHTML = `
            <!-- Summary -->
            <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-gray-100 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-6 opacity-10">
                    <i data-lucide="sparkles" class="text-indigo-600 w-32 h-32"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">âœ¨ æ‚¨çš„å°ˆå±¬è¡Œç¨‹</h2>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button type="button" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-600 rounded-full text-sm font-bold hover:bg-emerald-100 transition-colors border border-emerald-100 js-packing-list-btn">
                                ${iconHtml('list-checks', 'w-4 h-4')}
                                è¡Œææ¸…å–®
                            </button>
                        </div>
                    </div>
                    <p class="text-lg text-gray-600 leading-relaxed mb-8 font-medium">
                        ${escapeHtml(plan.summary || '')}
                    </p>
                    <div class="flex flex-col md:flex-row gap-8 items-start bg-gray-50 rounded-2xl p-6">
                        <div class="w-full md:w-1/3 text-center md:text-left md:pl-4">
                            <span class="text-sm text-gray-400 uppercase tracking-wider font-bold">é ä¼°ç¸½èŠ±è²»</span>
                            <div class="text-4xl font-black text-indigo-600 mt-1 tracking-tight flex items-baseline gap-1">
                                <span class="text-xl font-bold text-indigo-400">${currentFormData.currency}</span>
                                ${totalBudget.toLocaleString()}
                            </div>
                            <div class="text-xs text-gray-400 mt-2">åŒ…å«é£Ÿå®¿èˆ‡äº¤é€šé ä¼°</div>
                        </div>
                        ${renderBreakdown(plan.breakdown)}
                    </div>
                </div>
            </div>
            <!-- Itinerary -->
            <div class="space-y-6">
                ${renderItinerary(plan.itinerary)}
            </div>
        `;
        // Icon render
        if (window.lucide) {
            window.lucide.createIcons();
        }
        // è¡Œææ¸…å–®æŒ‰éˆ•
        planOutput.querySelectorAll('.js-packing-list-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showPackingList();
            });
        });
        // tips æŒ‰éˆ•
        planOutput.querySelectorAll('.js-tips-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const title = btn.dataset.title || '';
                const location = btn.dataset.location || '';
                showTips(title, location);
            });
        });

        // å‹¾é€‰é€»è¾‘
        setupSelectionHandlers();

        planOutput.classList.remove('hidden');
        if (chatPanel) {
            chatPanel.classList.remove('hidden');
        }
        if (chatMessages && chatMessages.children.length === 0) {
            appendChatMessage('system', 'å·²ç”Ÿæˆè¡Œç¨‹ï¼Œå¯ä»¥å‹¾é¸éœ€è¦èª¿æ•´çš„è¡Œç¨‹ï¼Œä¸¦åœ¨æ­¤å°è©±æ¬„è¨˜éŒ„å…·é«”ä¿®æ”¹éœ€æ±‚ã€‚');
        }
    };

    const showError = (message) => {
        errorText.textContent = message;
        errorMessage.classList.remove('hidden');
    };

    const hideError = () => {
        errorMessage.classList.add('hidden');
        errorText.textContent = '';
    };

    const handleGeneratePlan = async (e) => {
        if (e) e.preventDefault();
        if (isGenerating) return;

        currentFormData = {
            destination: destinationInput.value.trim(),
            days: parseInt(daysInput.value, 10),
            budget: parseInt(budgetInput.value, 10),
            currency: currencySelect.value,
            style: styleInput.value.trim()
        };

        if (!currentFormData.destination || currentFormData.days < 1 || isNaN(currentFormData.budget) || currentFormData.budget < 0) {
            showError("è«‹å¡«å¯«æ‰€æœ‰å¿…è¦çš„æ¬„ä½ã€‚");
            return;
        }

        isGenerating = true;
        generateButton.disabled = true;
        generateButton.classList.remove('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'hover:brightness-110');
        generateButton.classList.add('bg-slate-400', 'cursor-not-allowed');
        buttonText.innerHTML = `${iconHtml('loader-2', 'w-5 h-5 animate-spin')} è¦åŠƒè¡Œç¨‹ä¸­...`;
        hideError();
        initialState.classList.add('hidden');
        planOutput.classList.add('hidden');
        loadingState.classList.remove('hidden');

        try {
            let planData;
            if (isApiReady()) {
                // ä¹‹å¾Œå¦‚æœè¦æ¥çœŸçš„ Gemini APIï¼Œå¯ä»¥åœ¨é€™è£¡å‘¼å«
                planData = MOCK_DATA;
            } else {
                apiWarning.classList.remove('hidden');
                await new Promise(resolve => setTimeout(resolve, 1200));
                planData = MOCK_DATA;
            }

            currentPlan = planData;
            renderPlan(planData);
        } catch (error) {
            console.error("ç”Ÿæˆè¡Œç¨‹å¤±æ•—:", error);
            showError(`ç„¡æ³•ç”Ÿæˆè¡Œç¨‹: ${error.message || 'é€£ç·šéŒ¯èª¤ã€‚'}`);
            currentPlan = MOCK_DATA;
            renderPlan(MOCK_DATA);
        } finally {
            isGenerating = false;
            generateButton.disabled = false;
            generateButton.classList.remove('bg-slate-400', 'cursor-not-allowed');
            generateButton.classList.add('bg-gradient-to-r', 'from-indigo-600', 'to-purple-600', 'hover:brightness-110');
            buttonText.innerHTML = `${iconHtml('sparkles', 'w-5 h-5 animate-pulse')} é–‹å§‹ AI è¦åŠƒ`;
            loadingState.classList.add('hidden');
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }
    };

    // ========= Chat æäº¤ =========
    const handleChatSubmit = (e) => {
        e.preventDefault();
        if (!chatInput) return;
        const msg = chatInput.value.trim();
        if (!msg) return;
        appendChatMessage('user', msg);
        chatInput.value = '';
        // Demo å›è¦†ï¼šä¹‹å¾Œå¯ä»¥æ”¹æˆçœŸæ­£ AI å›è¦†
        appendChatMessage('system', 'å·²è¨˜éŒ„ï¼Œä¹‹å¾Œå¯ä»¥æ ¹æ“šä½ å‹¾é¸çš„è¡Œç¨‹ä¸€èµ·èª¿æ•´ã€‚');
    };

    // ========= Modal =========
    const openModal = (title, contentHtml) => {
        modalContentContainer.innerHTML = `
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    ${title}
                </h3>
                <button type="button" class="text-gray-400 hover:text-gray-600 hover:bg-gray-200 p-2 rounded-full transition-all js-modal-close-btn">
                    ${iconHtml('x', 'w-5 h-5')}
                </button>
            </div>
            <div class="p-6 overflow-y-auto custom-scrollbar">
                ${contentHtml}
            </div>
            <div class="p-4 border-t border-gray-100 text-right bg-white">
                <button type="button" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors js-modal-close-btn">
                    é—œé–‰
                </button>
            </div>
        `;
        modalBackdrop.classList.remove('hidden');
        if (window.lucide) {
            window.lucide.createIcons();
        }
        modalContentContainer.querySelectorAll('.js-modal-close-btn').forEach(btn => {
            btn.addEventListener('click', closeModal);
        });
    };

    const closeModal = () => {
        modalBackdrop.classList.add('hidden');
    };

    const showPackingList = async () => {
        const packingTitle = `${iconHtml('list-checks', 'w-5 h-5 text-emerald-500')} è¡Œææ¸…å–®`;
        const loadingHtml = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                ${iconHtml('loader-2', 'w-10 h-10 animate-spin text-emerald-500 mb-4')}
                <p>æ­£åœ¨æ ¹æ“šæ‚¨çš„ç›®çš„åœ°èˆ‡é¢¨æ ¼åˆ†ææ‰€éœ€ç‰©å“...</p>
            </div>
        `;
        openModal(packingTitle, loadingHtml);

        try {
            let listData;
            await new Promise(resolve => setTimeout(resolve, 1000));
            listData = MOCK_PACKING_LIST; // demo ç”¨

            const listHtml = `
                <div class="space-y-6">
                    <p class="text-sm text-gray-500 bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                        âœˆï¸ é€™æ˜¯ç‚ºæ‚¨çš„ <strong>${escapeHtml(currentFormData.destination || '')} ${currentFormData.days || ''}å¤©</strong> ä¹‹æ—…æº–å‚™çš„å»ºè­°æ¸…å–®ã€‚
                    </p>
                    ${listData.categories.map(cat => `
                        <div class="bg-white rounded-xl border border-gray-100 overflow-hidden shadow-sm">
                            <div class="bg-gray-50 px-4 py-2 font-bold text-gray-700 border-b border-gray-100 flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                                ${escapeHtml(cat.name)}
                            </div>
                            <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-2">
                                ${cat.items.map(item => `
                                    <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                                        <input type="checkbox" class="rounded text-emerald-500 focus:ring-emerald-500 cursor-pointer" />
                                        <span>${escapeHtml(item)}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            openModal(packingTitle, listHtml);
        } catch (e) {
            openModal(packingTitle, '<div class="text-center py-8 text-red-500">ç”Ÿæˆæ¸…å–®å¤±æ•—ã€‚</div>');
        }
    };

    const showTips = async (activityTitle, location) => {
        const tipsTitle = `${iconHtml('lightbulb', 'w-5 h-5 text-amber-500')} ${escapeHtml(activityTitle)} é”äººæ”»ç•¥`;
        const loadingHtml = `
            <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                ${iconHtml('loader-2', 'w-10 h-10 animate-spin text-amber-500 mb-4')}
                <p>æ­£åœ¨å°‹æ‰¾æœ€ä½³æ”»ç•¥...</p>
            </div>
        `;
        openModal(tipsTitle, loadingHtml);
        await new Promise(resolve => setTimeout(resolve, 800));
        const tipsContent = `<div class="text-gray-700 leading-relaxed text-lg p-2">${MOCK_TIPS}</div>`;
        openModal(tipsTitle, tipsContent);
    };

    // ========= äº‹ä»¶ =========
    document.getElementById('plan-form').addEventListener('submit', handleGeneratePlan);

    if (chatForm) {
        chatForm.addEventListener('submit', handleChatSubmit);
    }

    if (!isApiReady()) {
        apiWarning.classList.remove('hidden');
    }
</script>
</body>
</html>
